!function(){function e(t,e){return Math.floor(Math.random()*(e+1-t)+t)}function s(t,e){return Math.random()*(e-t)+t}function a(t){return t[e(0,t.length-1)]}function i(t,e=0){return t.x-view.x+e>0&&t.y-view.y+e>0&&t.x-view.x-e<w&&t.y-view.y-e<h}function n(t,e=1,s=0,a=.5,i=0){var r=window.audioCtx.createBufferSource(),n=window.audioCtx.createGain(),h=window.audioCtx.createStereoPanner();return r.buffer=t,r.connect(h),h.connect(n),n.connect(audioMaster),r.playbackRate.value=e,r.loop=i,n.gain.value=a,h.pan.value=s,r.start(),{volume:n,sound:r}}const o={_pressed:{},_released:{},LEFT:37,UP:38,RIGHT:39,DOWN:40,SPACE:32,ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,a:65,c:67,w:87,s:83,d:68,z:90,x:88,f:70,p:80,q:81,r:82,m:77,h:72,isDown(t){return this._pressed[t]},justReleased(t){return this._released[t]},onKeydown(t){this._pressed[t.keyCode]=1},onKeyup(t){this._released[t.keyCode]=1,delete this._pressed[t.keyCode]},update(){this._released={}}},l=(t,e,s)=>Math.min(Math.max(t,e),s);function c(t,e,s,a){var{cos:i,sin:r}=Math,n=i(e),h=r(e),o=i(a),l=r(a),c=i(-s),d=r(-s);return{x:n*o*t.x+(n*l*d-h*c)*t.y+(n*l*c+h*d)*t.z,y:h*o*t.x+(h*l*d+n*c)*t.y+(h*l*c-n*d)*t.z,z:-l*t.x+o*d*t.y+o*c*t.z}}function d(t,e,s,a){var i,r,{cos:n,sin:h,sqrt:o,atan2:l}=Math;e-=a.camY,i=l(t-=a.camX,s-=a.camZ),r=o(t*t+s*s),t=h(i-a.yaw)*r,i=l(e,s=n(i-a.yaw)*r),r=o(e*e+s*s),e=h(i-a.pitch)*r;var c=200*((s=n(i-a.pitch)*r)-0)-0*(t-0),d=(1*(t-0)- -100*(s-0))/c,p=200/c;return d>0&&1>d&&p>0&&1>p?{x:a.cx+(200*d-100)*a.scale,y:a.cy+e/s*a.scale,d:o(t*t+e*e+s*s)}:{d:-1}}function p(t,e,s){this.x=t,this.y=e,this.z=s}const f={CIR:0,SQ:1,PT:2,TRI:3,SPRITE:4};class u{constructor(t,e,s,a={F:{C1:22,C2:0,pattern:r.DTH[0]},shape:f.point,size:1,angle:0,triangles:[]}){this.vert=new p(t,e,s),this.size=a.size,this.shape=a.shape,this.F=a.F,this.triangles=a.triangles,this.angle=a.angle}draw(t){let e=d(this.vert.x,this.vert.y,this.vert.z,t);if(-1!=e.d&&500>e.d&&i(e,100)){let{x:s,y:a}=e,n=this.size,h=this.shape,o=this.F,{C1:l,C2:p,pattern:f}=o,u=n*(40/e.d);if(1>u&&3!=h)return;switch(r.P2=p,r.pat=f,h){case 0:1>u?r.pset(s,a,this.F.stroke?this.F.stroke:l,e.d):(r.fillCircle(s,a,u,l,e.d),r.pat=r.DTH[0],this.F.stroke&&r.circle(s,a,u,this.F.stroke,e.d));break;case 1:r.fillRect(s-u/2,a-u/2,u,u,l,e.d),this.F.stroke&&r.rect(s-u/2,a-u/2,u,u,this.F.stroke,e.d);break;case 2:r.pset(s,a,l,e.d);break;case 3:let h=[];for(let e=0;this.triangles.length>e;e++){let s=this.triangles[e],a=this.vert,r=[];for(let e=0;s.points.length>e;e++){let h=s.points[e];h=c(h,this.angle,0,0);let o=d(h.x*n+a.x,h.y*n+a.y,a.z,t);-1!=o.d&&500>o.d&&i(o,100)&&r.push(o)}3==r.length&&(r.color=s.color,h.push(r))}for(let t=0;h.length>t;t++){let s=h[t];r.fillTriangle(s[0],s[1],s[2],s.color,e.d)}}r.P2=64,r.pat=r.DTH[0]}}}class m{constructor(t,e,s,a){this.location=new p(t,e,s),this.splats=a,this.splats.forEach(t=>{t.vert.x+=this.location.x,t.vert.y+=this.location.y,t.vert.z+=this.location.z})}updatePosition(t,e,s){this.location.x+=t,this.location.y+=e,this.location.z+=s,this.splats.forEach(a=>{a.vert.x+=t,a.vert.y+=e,a.vert.z+=s})}rotate(t,e,s){this.splats.forEach(a=>{a.vert.x-=this.location.x,a.vert.y-=this.location.y,a.vert.z-=this.location.z,a.vert=c(a.vert,t,e,s),a.vert.x+=this.location.x,a.vert.y+=this.location.y,a.vert.z+=this.location.z})}}class g{constructor(t,e,s,a){this.WIDTH=t,this.HEIGHT=e,this.PAGESIZE=this.WIDTH*this.HEIGHT,this.PAGES=a,this.atlas=s,this.SCREEN=0,this.PAGE_1=this.PAGESIZE,this.PAGE_2=2*this.PAGESIZE,this.PAGE_3=3*this.PAGESIZE,this.PAGE_4=4*this.PAGESIZE,this.cursorX=0,this.cursorY=0,this.P1=22,this.P2=64,this.stencil=0,this.stencilSource=this.PAGE_2,this.stencilOffset=0,this.colors=this.atlas.slice(0,64),this.palDefault=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63],this.c=document.createElement("canvas"),this.c.width=this.WIDTH,this.c.height=this.HEIGHT,this.ctx=this.c.getContext("2d"),this.renderTarget=0,this.renderSource=this.PAGESIZE,this.fontString="ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890_!@#.'\"?/<()",this.fontBitmap="11111100011111110001100011111010001111101000111110111111000010000100000111111100100101000110001111101111110000111001000011111111111000011100100001000011111100001011110001111111000110001111111000110001111110010000100001001111111111000100001010010111101000110010111001001010001100001000010000100001111110001110111010110001100011000111001101011001110001011101000110001100010111011110100011001011100100000111010001100011001001111111101000111110100011000101111100000111000001111101111100100001000010000100100011000110001100010111010001100011000101010001001000110001101011010101110100010101000100010101000110001010100010000100001001111100010001000100011111001000110000100001000111001110100010001000100111111111000001001100000111110100101001011111000100001011111100001111000001111100111110000111101000101110111110000100010001000010001110100010111010001011100111010001011110000101110011101000110001100010111000000000000000000000111110010000100001000000000100111111000110111101011011101010111110101011111010100000000000000000000000100001100001000100000000000011011010011001000000000000111010001001100000000100000010001000100010001000000010001000100000100000100001000100001000010000010",this.pal=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64],this.DTH=[65535,65527,65015,65013,62965,62901,58805,58789,42405,42401,42145,42144,41120,40992,32800,32768,0,63903,1632,63624],this.pat=65535,this.ctx.imageSmoothingEnabled=0,this.imageData=this.ctx.getImageData(0,0,this.WIDTH,this.HEIGHT),this.buf=new ArrayBuffer(this.imageData.data.length),this.buf8=new Uint8Array(this.buf),this.data=new Uint32Array(this.buf),this.ram=new Uint8Array(this.WIDTH*this.HEIGHT*this.PAGES),this.zbuf=new Float64Array(this.WIDTH*this.HEIGHT)}setPen(t,e,s=0){this.P1=t,this.P2=e,this.pat=s}clr(t,e){this.ram.fill(t,e,e+this.PAGESIZE),this.zbuf.fill(9999999999,0,this.WIDTH*this.HEIGHT)}pset(t,e,s,a=0){if(0>t|t>this.WIDTH-1)return;if(0>e|e>this.HEIGHT-1)return;if(a>this.zbuf[e*this.WIDTH+t])return;let i=this.pat&Math.pow(2,(e|=0)%4*4+(t|=0)%4)?s:this.P2;64!=i&&(this.ram[this.renderTarget+e*this.WIDTH+t]=i,this.zbuf[e*this.WIDTH+t]=a)}pget(t,e,s=0){return this.ram[s+(t|=0)+(e|=0)*this.WIDTH]}span(t,e,s,a,i){t|=0,e|=0,a|=0;for(let r=0;s>r;r++)this.pset(t+r,e,a,i)}span2(t,e,s,a,i,r){e|=0,a|=0,i|=0;let n=Math.abs((s|=0)-(t|=0))+1,h=s>t?t:s,o=a>e?e:a;for(let t=0;n>t;t++)this.pset(h+t,o,i,r)}line(t,e,s,a,i,r=0){var n,h,o=(a|=0)-(e|=0),l=(s|=0)-(t|=0);if(0>o?(o=-o,h=-1):h=1,0>l?(l=-l,n=-1):n=1,o<<=1,l<<=1,this.pset(t,e,i,r),l>o)for(var c=o-(l>>1);t!=s;)0>c||(e+=h,c-=l),c+=o,this.pset(t+=n,e,i,r);else for(c=l-(o>>1);e!=a;)0>c||(t+=n,c-=o),c+=l,this.pset(t,e+=h,i,r)}line3d(t,e,s,a,i,r,n){var h,o,l,c=(i|=0)-(e|=0),d=(a|=0)-(t|=0),p=r-s,f=[];if(0>c?(c=-c,o=-1):o=1,0>d?(d=-d,h=-1):h=1,c<<=1,d<<=1,this.pset(t,e,n,s),d>c)for(var u=c-(d>>1);t!=a;)0>u||(e+=o,u-=d),u+=c,f.push({x:t+=h,y:e});else for(u=d-(c>>1);e!=i;)0>u||(t+=h,u-=c),u+=d,f.push({x:t,y:e+=o});l=p/f.length;for(let t=0;f.length>t;t++)this.pset(f[t].x,f[t].y,n,l*t+s)}tline(t,e,s,a,i=0,r=0,n=0,h=0){var o,l,c=(a|=0)-(e|=0),d=(s|=0)-(t|=0);0>c?(c=-c,l=-1):l=1,0>d?(d=-d,o=-1):o=1;for(var p=t,f=e,u=(c<<=1)-((d<<=1)>>1);p!=s;)0>u||(f+=l,u-=d),u+=c,this.pset(p+=o,f,this.pget(p-i,f-r,this.renderSource)+n)}circle(t,e,s,a,i=0){t|=0,e|=0,a|=0;for(let r=-(s|=0);s>=r;r++)for(let n=-s;s>=n;n++)s*s-s>n*n+r*r||n*n+r*r>s*s+s||this.pset(t+n,e+r,a,i)}fillCircle(t,e,s,a,i=0){t|=0,e|=0,a|=0;for(let r=-(s|=0);s>=r;r++)for(let n=-s;s>=n;n++)n*n+r*r>s*s||this.pset(t+n,e+r,a,i)}tfillCircle(t,e,s,a=0,i=0){if(t|=0,e|=0,s|=0,offX=t-mw,offY=e-mh,s>=0){t|=0,e|=0;var r=-(s|=0),n=0,h=2-2*s;do{this.tline(t-r,e-n,t+r,e-n,offX,offY,a,i),this.tline(t-r,e+n,t+r,e+n,offX,offY,a,i),(s=h)>n||(h+=2*++n+1),(s>r||h>n)&&(h+=2*++r+1)}while(0>r)}}rect(t,e,s,a,i,r=0){let n=0|t,h=0|e,o=t+s|0,l=e+a|0;this.line(n,h,o,h,i,r),this.line(o,h,o,l,i,r),this.line(n,l,o,l,i,r),this.line(n,h,n,l,i,r)}fillRect(t,e,s,a,i,r=0){let n=0|t,h=0|e,o=0|s,l=(e+a|0)-1;i=i;var c=Math.abs(l-h);if(this.span(n,h,o,i,r),c>0)for(;--c;)this.span(n,h+c,o,i,r);this.span(n,l,o,i,r)}sspr(t=0,e=0,s=16,a=16,i=0,r=0,n=32,h=32,o=0,l=0,c=0){var d=s/n,p=a/h;this.pat=this.DTH[0];for(var f=0;h>f;f++)for(var u=0;n>u;u++)px=u*d|0,py=f*p|0,e=l?a-py-f:e,t=o?s-px-u:t,source=this.pget(t+px,e+py,this.renderSource),source>0&&this.pset(i+u,r+f,source)}outline(t,e,s,a,i,r){for(let t=0;this.WIDTH>=t;t++)for(let e=0;this.HEIGHT>=e;e++){let n=t-1+e*this.WIDTH,h=t+1+e*this.WIDTH,o=t+(e+1)*this.WIDTH,l=t+(e-1)*this.WIDTH;this.ram[this.renderSource+(t+e*this.WIDTH)]&&(64==this.ram[this.renderSource+n]&&(this.ram[this.renderTarget+n]=s),64==this.ram[this.renderSource+h]&&(this.ram[this.renderTarget+h]=i),64==this.ram[this.renderSource+l]&&(this.ram[this.renderTarget+l]=a),64==this.ram[this.renderSource+o]&&(this.ram[this.renderTarget+o]=r))}}triangle(t,e,s,a,i=0){this.line(t.x,t.y,e.x,e.y,a),this.line(e.x,e.y,s.x,s.y,a),this.line(s.x,s.y,t.x,t.y,a)}strokePolygon(t,e,s,a,i=0,r="white"){a=a||Math.floor(240*s)+16;for(let n=0;a>n;n++){let h=n/a*6.283185,o=(n+1)/a*6.283185;this.line(t+Math.cos(h+i)*s,e+Math.sin(h+i)*s,t+Math.cos(o+i)*s,e+Math.sin(o+i)*s,r)}}fillTriangle(t,e,s,a,i){let r=[Object.assign({},t),Object.assign({},e),Object.assign({},s)].sort((t,e)=>t.y-e.y),n=r[0],h=r[1],o=r[2],l=0,c=0,d=0,p={},f={};if(h.y-n.y>0&&(l=(h.x-n.x)/(h.y-n.y)),o.y-n.y>0&&(c=(o.x-n.x)/(o.y-n.y)),o.y-h.y>0&&(d=(o.x-h.x)/(o.y-h.y)),Object.assign(p,n),Object.assign(f,n),l>c){for(;h.y>=p.y;p.y++,f.y++,p.x+=c,f.x+=l)this.span2(p.x,p.y,f.x,p.y,a,i);for(f=h;o.y>=p.y;p.y++,f.y++,p.x+=c,f.x+=d)this.span2(p.x,p.y,f.x,p.y,a,i)}else{for(;h.y>=p.y;p.y++,f.y++,p.x+=l,f.x+=c)this.span2(p.x,p.y,f.x,p.y,a,i);for(p=h;o.y>=p.y;p.y++,f.y++,p.x+=d,f.x+=c)this.span2(p.x,p.y,f.x,p.y,a,i)}}imageToRam(t,e){let s=document.createElement("canvas");s.width=WIDTH,s.height=HEIGHT;let a=s.getContext("2d");a.drawImage(t,0,0);var i=a.getImageData(0,0,WIDTH,HEIGHT);let r=new Uint32Array(i.data.buffer),n=0;for(len=r.length;n<len;)ram[e+n]=colors.indexOf(r[n]),n++}render(){let t=0,e=this.PAGESIZE;for(;e>t;)this.data[t]=this.colors[this.pal[this.ram[t]]],t++;this.imageData.data.set(this.buf8),this.c.width=this.c.width,this.ctx.putImageData(this.imageData,0,0)}textLine(t){let e=t[0].length;for(var s=0;e>s;s++){let e=this.getCharacter(t[0].charAt(s));for(var a=0;5>a;a++)for(var i=0;5>i;i++)1==e[5*a+i]&&(1==t[4]?this.pset(t[1]+i*t[4]+(5*t[4]+t[3])*s,t[2]+a*t[4]|0,t[5]):this.fillRect(t[1]+i*t[4]+(5*t[4]+t[3])*s,t[2]+a*t[4]|0,t[4],t[4],t[5]))}}text(t){let e=5*t[7],s=t[0].split("\n"),a=s.slice(0),i=s.length,r=a.sort((t,e)=>e.length-t.length)[0],n=r.length*e+(r.length-1)*t[3],h=i*e+(i-1)*t[4];t[5]||(t[5]="left"),t[6]||(t[6]="bottom");var o=t[1],l=t[2],c=t[1]+n,d=t[2]+h;"center"==t[5]?(o=t[1]-n/2,c=t[1]+n/2):"right"==t[5]&&(o=t[1]-n,c=t[1]),"center"==t[6]?(l=t[2]-h/2,d=t[2]+h/2):"bottom"==t[6]&&(l=t[2]-h,d=t[2]);for(var p=o+n/2,f=l+h/2,u=0;i>u;u++){let a=s[u],i=a.length*e+(a.length-1)*t[3],r=t[1],n=t[2]+(e+t[4])*u;"center"==t[5]?r=t[1]-i/2:"right"==t[5]&&(r=t[1]-i),"center"==t[6]?n-=h/2:"bottom"==t[6]&&(n-=h),this.textLine([a,r,n,t[3],t[7],t[8]])}return{sx:o,sy:l,cx:p,cy:f,ex:c,ey:d,width:n,height:h}}getCharacter(t){let e=this.fontString.indexOf(t);return this.fontBitmap.substring(25*e,25*e+25).split("")}}var E=function(){var t,e,s,a,i,r=t=>Math.sin(6.283184*t),n=t=>.003959503758*2**((t-128)/12),h=(t,e,s)=>{var a,i,r,h,l,c,d=o[t.i[0]],p=t.i[1],f=t.i[3]/32,u=o[t.i[4]],w=t.i[5],m=t.i[8]/32,y=t.i[9],x=t.i[10]*t.i[10]*4,g=t.i[11]*t.i[11]*4,E=t.i[12]*t.i[12]*4,v=1/E,T=-t.i[13]/16,D=t.i[14],I=s*2**(2-t.i[15]),C=new Int32Array(x+g+E),S=0,H=0;for(a=0,i=0;x+g+E>a;a++,i++)0>i||(i-=I,l=n(e+(15&(D=D>>8|(255&D)<<4))+t.i[2]-128),c=n(e+(15&D)+t.i[6]-128)*(1+8e-4*t.i[7])),r=1,x>a?r=a/x:x+g>a||(r=(1-(r=(a-x-g)*v))*3**(T*r)),h=d(S+=l*r**f)*p,h+=u(H+=c*r**m)*w,y&&(h+=(2*Math.random()-1)*y),C[a]=80*h*r|0;return C},o=[r,t=>.5>t%1?1:-1,t=>t%1*2-1,t=>{var e=t%1*4;return 2>e?e-1:3-e}];this.init=r=>{t=r,s=0,a=r.rowLen*r.patternLen*((e=r.endPattern)+1)*2,i=new Int32Array(a)},this.generate=()=>{var n,l,c,d,p,f,u,w,m,y,x,g,E,v,T=new Int32Array(a),D=t.songData[s],I=t.rowLen,C=t.patternLen,S=0,H=0,A=0,M=[];for(c=0;e>=c;++c)for(u=D.p[c],d=0;C>d;++d){var b=u?D.c[u-1].f[d]:0;b&&(D.i[b-1]=D.c[u-1].f[d+C]||0,17>b&&(M=[]));var R=o[D.i[16]],z=D.i[17]/512,L=2**(D.i[18]-9)/I,W=D.i[19],P=D.i[20],G=135.82764118168*D.i[21]/44100,N=1-D.i[22]/255,k=1e-5*D.i[23],O=D.i[24]/32,F=D.i[25]/512,Z=6.283184*2**(D.i[26]-9)/I,X=D.i[27]/255,U=D.i[28]*I&-2;for(x=(c*C+d)*I,p=0;4>p;++p)if(f=u?D.c[u-1].n[d+p*C]:0){M[f]||(M[f]=h(D,f,I));var Y=M[f];for(l=0,n=2*x;Y.length>l;l++,n+=2)T[n]+=Y[l]}for(l=0;I>l;l++)(y=T[w=2*(x+l)])||A?(g=G,W&&(g*=R(L*w)*z+.5),H+=(g=1.5*Math.sin(g))*(E=N*(y-H)-(S+=g*H)),y=3==P?H:1==P?E:S,k&&(y=1>(y*=k)?y>-1?r(.25*y):-1:1,y/=k),A=(y*=O)*y>1e-5,v=y*(1-(m=Math.sin(Z*w)*F+.5)),y*=m):v=0,U>w||(v+=T[w-U+1]*X,y+=T[w-U]*X),T[w]=0|v,T[w+1]=0|y,i[w]+=0|v,i[w+1]+=0|y}return++s/t.numChannels},this.createAudioBuffer=t=>{for(var e=t.createBuffer(2,a/2,44100),s=0;2>s;s++)for(var r=e.getChannelData(s),n=s;a>n;n+=2)r[n>>1]=i[n]/65536;return e},this.createWave=()=>{var t=44+2*a-8,e=t-36,s=new Uint8Array(44+2*a);s.set([82,73,70,70,255&t,t>>8&255,t>>16&255,t>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&e,e>>8&255,e>>16&255,e>>24&255]);for(var r=0,n=44;a>r;++r){var h=i[r];s[n++]=255&(h=-32767>h?-32767:h>32767?32767:h),s[n++]=h>>8&255}return s},this.getData=(t,e)=>{for(var s=2*Math.floor(44100*t),a=Array(e),r=0;2*e>r;r+=1){var n=s+r;a[r]=t>0&&i.length>n?i[n]/32768:0}return a}};class v{constructor(t,e,s){this.x=t,this.y=e,this.lifeMax=s,this.life=s,this.alive=1,this.color=3}draw(){r.pat=r.DTH[15-Math.floor(this.life/this.lifeMax*15)];for(let t=Math.floor(this.life/10);t>0;t--)r.fillCircle(this.x,this.y,this.lifeMax-this.life-t,this.color,0);r.fillCircle(this.x,this.y,this.lifeMax-this.life,this.color,0),r.pat=r.DTH[0]}update(){this.alive&&(this.life>0?this.life-=1:this.alive=0)}}class T{constructor(t,e,s){this.pos={x:t,y:e,z:s},this.prev={x:t,y:e,z:s},this.pd={x:0,y:0,z:0},this.acc={x:0,y:0},this.Macc={x:.1,y:.1},this.macc={x:-.1,y:-.1},this.v={x:0,y:0},this.MV={x:2,y:2},this.mV={x:-2,y:-2},this.drag={x:.9,y:.9},this.accD={x:.5,y:.5},this.alive=1,this.pA=0,this.a=Math.atan2(this.pos.y,this.pos.x),this.aD=0,this.sprite=this.initializeShape()}draw(){this.alive&&this.sprite.splats.forEach(t=>t.draw(camera))}update(){if(this.alive)switch(this.prev.x=this.pos.x,this.prev.y=this.pos.y,this.pA=this.a,this.v.x+=this.acc.x,this.v.y+=this.acc.y,this.v.x*=this.drag.x,this.v.y*=this.drag.y,this.v.x=l(this.v.x,this.mV.x,this.MV.x),this.v.y=l(this.v.y,this.mV.y,this.MV.y),this.acc.x*=this.accD.x,this.acc.y*=this.accD.y,this.acc.x=l(this.acc.x,this.macc.x,this.Macc.x),this.acc.y=l(this.acc.y,this.macc.y,this.Macc.y),this.pos.x+=this.v.x,this.pos.y+=this.v.y,this.a=Math.atan2(this.pos.y,this.pos.x),this.pd.x=this.pos.x-this.prev.x,this.pd.y=this.pos.y-this.prev.y,this.pd.z=this.pos.z-this.prev.z,this.aD=this.a-this.pA,gamestate){case WELL:this.collideWithCylinderWall(30)&&(r.fillRect(0,0,w,10,4),this.death())}else this.pd={x:0,y:0,z:0},this.aD=0;this.sprite.updatePosition(this.pd.x,this.pd.y,this.pd.z),this.sprite.rotate(this.aD,0,0)}move(t,e){this.acc.x+=t,this.acc.y+=e}initializeShape(){let t=[];t.push(new u(0,0,5,{shape:0,F:{C1:21,C2:0,stroke:1,pattern:r.DTH[0]},size:14}));for(let e=0;12>e;e++)t.push(new u(0,0,4-e,{shape:0,F:{C1:21,C2:0,stroke:1,pattern:r.DTH[0]},size:10}));for(let e=0;9>e;e++)t.push(new u(-4+e,0,2,{shape:0,F:{C1:21,C2:0,stroke:1,pattern:r.DTH[0]},size:8}));for(let e=0;7>e;e++)t.push(new u(-2+e,0,-1,{shape:0,F:{C1:21,C2:0,stroke:1,pattern:r.DTH[0]},size:8}));return new m(this.pos.x,this.pos.y,this.pos.z,t)}collideWithCylinderWall(t){let e=this.pos.x,s=this.pos.y;return Math.sqrt(e*e+s*s)>t}death(){deaths++,fallspeed=-.08,this.alive=0,this.splatter()}splatter(){let t=[];for(let a=0;40>a;a++)t.push(new u(Math.sin(this.a)*Math.random()*30,Math.cos(this.a)*Math.random()*30,s(0,100),{shape:0,F:{C1:3,C2:2,pattern:r.DTH[8]},size:e(7,15)}));worldSplatShapes.push(new m(this.pos.x,this.pos.y,this.pos.z,t));let{px:a,py:i,pz:n}=this.pos,h=d(a,i,n,camera);splodes.push(new v(h.x,h.y,30))}}var D={songData:[{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,0,195,6,1,2,135,0,0,32,147,6,28,6],p:[1],c:[{n:[147,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,152,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,154],f:[]}]}],rowLen:5088,patternLen:32,endPattern:0,numChannels:1},I={songData:[{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,0,195,6,1,2,135,0,0,32,147,6,55,6],p:[1],c:[{n:[151,151,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,154,154,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,159,159,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,135,135],f:[]}]}],rowLen:6014,patternLen:32,endPattern:0,numChannels:1},C={songData:[{i:[3,0,102,0,3,0,140,0,0,61,2,2,47,61,0,0,0,96,3,1,3,94,79,0,32,84,2,12,4],p:[1],c:[{n:[147,,,,,147,,,,,,,,147,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,147,,147,,,,,135,,,,135,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,135],f:[]}]},{i:[0,214,104,64,0,204,104,0,64,229,4,40,43,51,0,0,0,231,6,1,3,23,13,0,32,232,4,7,6],p:[1],c:[{n:[147],f:[]}]},{i:[0,13,140,0,0,0,140,0,0,24,4,10,47,55,0,0,0,187,5,0,2,39,44,0,32,108,2,16,4],p:[1],c:[{n:[123,,,,,,120,,,,,125,,,,,,123,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,124,,,,,,,,,,,,,,128,,,,,112],f:[]}]},{i:[0,255,116,79,0,111,116,0,83,0,4,6,69,52,0,0,0,0,0,0,2,14,0,0,32,0,0,0,0],p:[1],c:[{n:[123,125,,125,,,,123,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,130],f:[]}]}],rowLen:1323,patternLen:128,endPattern:0,numChannels:4},S={songData:[{i:[0,0,140,0,0,0,140,0,0,130,255,158,220,0,0,0,0,51,1,1,2,58,165,0,32,88,1,157,2],p:[1],c:[{n:[135],f:[]}]},{i:[0,0,140,0,0,0,140,0,0,255,35,9,65,0,0,0,0,51,2,1,2,17,239,0,32,88,1,85,2],p:[1],c:[{n:[,135,,135,,,,,,135,,,,,,,,,,135,,,,,,,,,135,,135,,,,,,,,,,,,135,,,,,,,,,135,135,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,135,,,,,,,,,,,,,,,,135,,,,,,,,,135,,,,,,,,,,,,,,,,,,,,,,,,,,137,,,,,,,137,,137,,,,137,,,,,,137,,,,,137,,,,,,,,135,,,,,,,,,,,,,,,,,,,,135,,,,,,,,,,,,,,,,,,,,,,,,,,135,,,,,,,,,135,,,,,,135,,,,,135,,,,,,135,,,,,,,,,,,,,,,,,,,,,,,,,,,,,137,,,,,,,,,,,,,,,,,,,,,137,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,135,,,,,,,,,,,,,,135],f:[]}]}],rowLen:5513,patternLen:128,endPattern:0,numChannels:2};W=window,800>innerWidth?(screenFactor=2,w=innerWidth/2,h=innerHeight/2):(screenFactor=4,w=Math.floor(innerWidth/4),h=Math.floor(innerHeight/4)),W.camera={},W.view={x:0,y:0},W.cursor={x:0,y:0,isDown:0},W.then=0,W.elapsed=0,W.now=0,W.framesPerSecond=60,W.fpsInterval=1e3/framesPerSecond,W.t=1,splodes=[],splatShapes=[],staticSplats=[],worldSplatShapes=[],obstacles=[],gamestate=0,paused=0,debug=0,started=0,sounds={},soundsReady=0,totalSounds=2,audioTxt="",debugText="",window.PRELOAD=0,window.GAME=1,window.TITLESCREEN=2,window.WELL=3,window.PURGATORY=4,window.HELL=5,window.HEAVEN=6,window.SCREENCENTERX=w/2,window.SCREENCENTERY=h/2,window.fallspeed=7,window.deaths=0,window.worldZ=0,window.deathText="",window.worldLength=1e4;const H=document.createElement("style");function A(){window.player=new T(0,5,90),(()=>{for(let t=0;6.25>t;t++){let s=[];for(let t=0;24>t;t++){let i=42,n=2*Math.PI/24,h=a([1,31,32]),o=new u(Math.sin(n*t)*i,Math.cos(n*t)*i,t%2==0?0:40,{size:7.6,shape:3,F:{C1:0,C2:a[1],pattern:r.DTH[e(0,8)]},angle:2*Math.PI*(-t/24),triangles:[{points:[{x:-1,y:-1,z:0},{x:1,y:-1,z:0},{x:-1.6,y:1,z:0}],color:h},{points:[{x:-1.6,y:1,z:0},{x:1,y:-1,z:0},{x:1.6,y:1,z:0}],color:h}]});s.push(o)}splatShapes.push(new m(0,0,80*t,s))}let t=[];for(let i=0;1e3>i;i++){let i=s(0,2*Math.PI),n=44,h=new p(Math.sin(i)*n,Math.cos(i)*n,500/60*e(0,60)+e(0,20)),o=new u(h.x,h.y,h.z,{F:{C1:a([1,31]),C2:a([1,31]),pattern:r.DTH[a([7,8])]},shape:0,size:e(15,30)});t.push(o)}splatShapes.push(new m(0,0,0,t))})(),camera={camX:0,camY:0,camZ:-10,pitch:0,yaw:0,cx:SCREENCENTERX,cy:SCREENCENTERY,scale:300}}function M(){requestAnimationFrame(M),now=Date.now(),elapsed=now-then,elapsed>fpsInterval&&(then=now-elapsed%fpsInterval,(()=>{switch(gamestate){case PRELOAD:r.clr(0,r.SCREEN),r.text([audioTxt,w/2-2,100,1,3,"center","top",1,22]),audioTxt="CLICK TO INITIALIZE\nGENERATION SEQUENCE",soundsReady==totalSounds?audioTxt="ALL SOUNDS RENDERED.\nTAP OR CLICK TO CONTINUE":started?audioTxt="SOUNDS RENDERING... "+soundsReady:audioTxt="CLICK TO INITIALIZE\nGENERATION SEQUENCE",soundsReady==totalSounds&&(gamestate=TITLESCREEN,cursor.isDown=0),r.render();break;case WELL:(()=>{if(debug){let t=0>camera.camZ?"NEG "+camera.camZ:camera.camZ;if(debugText=`X ${camera.camX.toFixed(3)}\nY ${camera.camY}\nZ ${t}\nPITCH ${camera.pitch}\nYAW ${camera.yaw}\n${player.acc.x.toFixed(3)}`,o.isDown(o.w)){let t=1;camera.camX+=Math.sin(camera.yaw)*Math.cos(camera.pitch)*t,camera.camZ+=Math.cos(camera.yaw)*Math.cos(camera.pitch)*t,camera.camY+=Math.sin(camera.pitch)*t}if(o.isDown(o.s)){let t=1;camera.camX-=Math.sin(camera.yaw)*Math.cos(camera.pitch)*t,camera.camZ-=Math.cos(camera.yaw)*Math.cos(camera.pitch)*t,camera.camY-=Math.sin(camera.pitch)*t}if(o.isDown(o.a)){let t=1;camera.camX-=1*Math.cos(-camera.yaw)*t,camera.camZ-=1*Math.sin(-camera.yaw)*t,camera.camY-=0*t}if(o.isDown(o.d)){let t=1;camera.camX+=1*Math.cos(-camera.yaw)*t,camera.camZ+=1*Math.sin(-camera.yaw)*t,camera.camY+=0*t}o.isDown(o.UP)&&(camera.pitch+=.01),o.isDown(o.DOWN)&&(camera.pitch-=.01),o.isDown(o.LEFT)&&(camera.yaw-=.01),o.isDown(o.RIGHT)&&(camera.yaw+=.01)}else{t+=1,worldZ+=fallspeed;let e=0,s=splatShapes.length;for(;s>e;){let t=splatShapes[e],s=0,a=t.splats.length;for(;a>s;){let e=t.splats[s];e.vert.z-=fallspeed,-10>e.vert.z&&(e.vert.z=500),s++}e++}for(e=0,s=worldSplatShapes.length;s>e;){let t=worldSplatShapes[e],s=0,a=t.splats.length;for(;a>s;){let e=t.splats[s];e.vert.z-=fallspeed,-10>e.vert.z&&(e.vert.z=worldLength),s++}e++}splodes.forEach(t=>{t.update()});let a=.05;(o.isDown(o.w)||o.isDown(o.z)||o.isDown(o.UP))&&player.move(0,-a),(o.isDown(o.s)||o.isDown(o.DOWN))&&player.move(0,a),(o.isDown(o.a)||o.isDown(o.q)||o.isDown(o.LEFT))&&player.move(-a,0),(o.isDown(o.d)||o.isDown(o.RIGHT))&&player.move(a,0),player.update()}(t=>{for(let e=0;t.length>e;e++)t[e].alive||t.splice(e,1)})(splodes)})(),(()=>{r.clr(0,r.SCREEN),r.pat=r.DTH[14],r.P2=0,r.fillRect(0,0,w,h,1,9999),r.P2=64,r.pat=r.DTH[0],player.draw();let t=0,e=splatShapes.length;for(;e>t;){let e=splatShapes[t],s=0,a=e.splats.length;for(;a>s;)e.splats[s].draw(camera),s++;t++}for(t=0,e=worldSplatShapes.length;e>t;){let e=worldSplatShapes[t],s=0,a=e.splats.length;for(;a>s;)e.splats[s].draw(camera),s++;t++}debug&&r.text([debugText,10,10,1,3,"left","top",1,22]),splodes.forEach(t=>{t.draw()}),r.render()})();break;case TITLESCREEN:(()=>{t++,cursor.isDown=0,r.clr(0,r.SCREEN);let s=595>t%600,a=s?"THE WELL":"THE LOOP",i=s?22:19;if(!s){let t=e(0,w),s=e(0,h);r.line(0,s,w,s,19),r.line(t,0,t,h,19)}r.text([a,w/2-2,100,2,3,"center","top",3,i]),a="CLICK TO BEGIN",r.text([a,w/2-2,120,1,3,"center","top",1,22]),r.render()})()}})()),o.justReleased(o.r)&&(gamestate=TITLESCREEN,window.t=1,splodes=[],splatShapes=[],player.alive=1,debug=0,fallspeed=7,A()),o.justReleased(o.ZERO)&&(debug=!debug),o.update()}H.type="text/css",H.innerText="\n  canvas {display: inline-block; height:100%; width:100%;  image-rendering: pixelated;\n    image-rendering: crisp-edges; background-color: black;}\n\n  * {\n    overflow: hidden;\n    background-color: black;\n    margin: 0;\n    }\n",document.head.appendChild(H),atlasImage=new Image,atlasImage.src="data:image/webp;base64,UklGRgYBAABXRUJQVlA4TPkAAAAvPwAAAAmAIPx/e4jof2oBEIT/bw8R/U/BbQAAZBPbrG0bm77naNt2L3FjAQCpfJvZtdk21m7QhbpU769xtW3XZicCAJBRmm1G6wHry3sBv3oJ2TaTzQgMgykOw60sEIPJ/NfmfEb0m+KfSWGWH/i/u8auMllLp0n52cfoLvVtXVYKFAcUZfWj5j87X4mHi8bzX1l8HrX3pPYcTlvOVVr9qo3Lavb/rXmB1LJcpoDHLXpMG3GbpNff9Hvj+WI8GbdW+8mBP7FawBlU3S655I2Sr7TX+Qybu3urf71W96O6lRfDTjcaDs1JZ6CujZezdr8z65838/1hdwAA",atlasImage.onload=function(){let t=document.createElement("canvas");t.width=64,t.height=64;let e=t.getContext("2d");e.drawImage(this,0,0),atlas=new Uint32Array(e.getImageData(0,0,64,64).data.buffer),window.r=new g(w,h,atlas,10),window.playSound=n,gamebox=document.getElementById("game"),gamebox.appendChild(r.c),M()},window.addEventListener("keyup",t=>{o.onKeyup(t)},0),window.addEventListener("keydown",t=>{o.onKeydown(t)},0),window.addEventListener("blur",()=>{paused=1},0),window.addEventListener("focus",()=>{paused=0},0),window.addEventListener("touchend",()=>{cursor.isDown=0},0),onWindowInteraction=t=>{switch(x=t.pageX,y=t.pageY,paused=0,gamestate){case PRELOAD:0!=soundsReady||started||(A(),audioCtx=new AudioContext,audioMaster=audioCtx.createGain(),compressor=audioCtx.createDynamicsCompressor(),compressor.threshold.setValueAtTime(-50,audioCtx.currentTime),compressor.knee.setValueAtTime(40,audioCtx.currentTime),compressor.ratio.setValueAtTime(12,audioCtx.currentTime),compressor.attack.setValueAtTime(0,audioCtx.currentTime),compressor.release.setValueAtTime(.25,audioCtx.currentTime),audioMaster.connect(compressor),compressor.connect(audioCtx.destination),sndData=[{name:"cellComplete",data:D},{name:"tada",data:I},{name:"rocksmash1",data:C},{name:"windrush",data:S}],totalSounds=sndData.length,soundsReady=0,sndData.forEach(t=>{const e=new E;e.init(t.data);let s=0;setInterval(()=>{if(!s&&(s=1==e.generate(),soundsReady+=s,s)){let s=e.createWave().buffer;audioCtx.decodeAudioData(s,e=>{sounds[t.name]=e})}},0)}),started=1);break;case TITLESCREEN:gamestate=WELL,n(sounds.windrush,1,0,.6,1),setTimeout(()=>{n(sounds.windrush,1,0,.6,1)},9e3);break;case WELL:break;case GAMEOVER:}},onclick=t=>{onWindowInteraction(t)},ontouchstart=t=>{onWindowInteraction(t)}}();
